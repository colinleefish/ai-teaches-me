# Kafka å¤ä¹ æ€»ç»“ - 2025 å¹´ 11 æœˆ 23 æ—¥

> è·ç¦»ä¸Šæ¬¡å­¦ä¹  Kafka å·²ç»è¿‡å»çº¦ 2 å‘¨ï¼Œè¿™æ˜¯ä¸€æ¬¡å…¨é¢å¤ä¹ ã€‚

## ä¸€ã€Kafka åŸºç¡€ (Basics)

### ä»€ä¹ˆæ˜¯ Kafka?

- **åˆ†å¸ƒå¼äº‹ä»¶æµå¹³å° (distributed event streaming platform)**ï¼Œç”¨äºé«˜ååé‡ã€å®¹é”™çš„æ•°æ®ç®¡é“
- ä½œä¸ºæ¶ˆæ¯ä»£ç† (message broker)ï¼Œç”Ÿäº§è€…å‘å¸ƒäº‹ä»¶åˆ° topicsï¼Œæ¶ˆè´¹è€…è®¢é˜… topics å¤„ç†äº‹ä»¶

### æ ¸å¿ƒæ¦‚å¿µ

- **Topics** - æ¶ˆæ¯çš„åˆ†ç±»/feed
- **Producers** - å‘å¸ƒæ¶ˆæ¯çš„åº”ç”¨
- **Consumers** - è®¢é˜…å¹¶å¤„ç†æ¶ˆæ¯çš„åº”ç”¨
- **Brokers** - Kafka æœåŠ¡å™¨ï¼Œå­˜å‚¨å’Œæä¾›æ•°æ®
- **Partitions** - åˆ†åŒºï¼Œç”¨äºå¹¶è¡Œå¤„ç†å’Œæ‰©å±•æ€§

### ä½¿ç”¨åœºæ™¯

1. å®æ—¶æ•°æ®ç®¡é“ (Real-time Data Pipelines)
2. äº‹ä»¶æº¯æº (Event Sourcing)
3. æ—¥å¿—èšåˆ (Log Aggregation)
4. æŒ‡æ ‡ç›‘æ§ (Metrics & Monitoring)
5. æ¶ˆæ¯é˜Ÿåˆ— (Message Queue)
6. æµå¤„ç† (Stream Processing)

## äºŒã€ç‰ˆæœ¬å’Œæ¶æ„æ¼”è¿› (Versions & Architecture)

### ä¸¤ç§å‘è¡Œç‰ˆ

- **Apache Kafka** (vanilla) - 4.0.x
  - Apache åŸºé‡‘ä¼šçš„å¼€æºé¡¹ç›®
  - é•œåƒ: `apache/kafka:latest`
- **Confluent Platform** - 8.1.0
  - å•†ä¸šå‘è¡Œç‰ˆï¼Œâ‰ˆ Apache Kafka 3.8/3.9
  - é•œåƒ: `confluentinc/cp-kafka:latest`
  - åŒ…å«: Schema Registry, ksqlDB, connectors ç­‰

### KRaft æ¨¡å¼æ¼”è¿›

- **Kafka 2.8.0 (2021)** - KRaft é¢„è§ˆç‰ˆ
- **Kafka 3.3.0 (2022)** - KRaft ç”Ÿäº§å°±ç»ª âœ…
- **Kafka 3.5.0+** - ZooKeeper è¢«å¼ƒç”¨
- **Kafka 4.0 (2024)** - **å®Œå…¨ç§»é™¤ ZooKeeper** âœ…

### ä¸ºä»€ä¹ˆä½¿ç”¨ KRaft?

- æ›´ç®€å•çš„æ¶æ„ (å°‘ä¸€ä¸ªä¾èµ–)
- æ›´å¿«çš„å…ƒæ•°æ®æ“ä½œ
- æ›´å¥½çš„å¯æ‰©å±•æ€§ (æ—  ZooKeeper ç“¶é¢ˆ)
- æ›´æ˜“éƒ¨ç½²å’Œç»´æŠ¤

## ä¸‰ã€æ ¸å¿ƒé…ç½® (Configuration)

### KRaft æ¨¡å¼å¿…å¤‡é…ç½®

#### `KAFKA_NODE_ID`

- èŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†ç¬¦ (unique identifier)
- å€¼: æ•´æ•° (1, 2, 3, ...)
- å¿…é¡»åœ¨é›†ç¾¤ä¸­å”¯ä¸€

#### `KAFKA_PROCESS_ROLES`

- å®šä¹‰èŠ‚ç‚¹çš„è§’è‰²
- å€¼:
  - `broker` - å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å’Œå­˜å‚¨æ•°æ®
  - `controller` - ç®¡ç†é›†ç¾¤å…ƒæ•°æ®å’Œ leader é€‰ä¸¾
  - `broker,controller` - ç»„åˆæ¨¡å¼ (ä¸¤ç§è§’è‰²éƒ½æœ‰)

#### `KAFKA_CONTROLLER_QUORUM_VOTERS`

- å‚ä¸å…±è¯†æŠ•ç¥¨çš„æ§åˆ¶å™¨èŠ‚ç‚¹åˆ—è¡¨
- æ ¼å¼: `NODE_ID@HOST:PORT,NODE_ID@HOST:PORT,...`
- **å¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šé…ç½®ç›¸åŒ!**

### ç½‘ç»œé…ç½® (æœ€å…³é”®!)

#### `KAFKA_LISTENERS` vs `KAFKA_ADVERTISED_LISTENERS`

**å…³é”®åŒºåˆ«:**

- `KAFKA_LISTENERS` - Kafka **ç»‘å®š**çš„ç½‘ç»œæ¥å£ (æœåŠ¡å™¨ç«¯)
- `KAFKA_ADVERTISED_LISTENERS` - Kafka **å‘Šè¯‰å®¢æˆ·ç«¯**çš„åœ°å€ (å®¢æˆ·ç«¯ç«¯)

**ä¸ºä»€ä¹ˆéœ€è¦ä¸¤è€…?**

1. å®¢æˆ·ç«¯è¿æ¥åˆ° bootstrap server (ä»»æ„ broker)
2. å®¢æˆ·ç«¯è¯·æ±‚é›†ç¾¤å…ƒæ•°æ®
3. Kafka è¿”å› **advertised addresses** (æ‰€æœ‰ broker çš„åœ°å€)
4. å®¢æˆ·ç«¯è¿æ¥åˆ° **advertised addresses** è¿›è¡Œå®é™…æ•°æ®ä¼ è¾“

**Docker ç¤ºä¾‹:**

```yaml
KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092" # å®¹å™¨å†…ç»‘å®š
KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092" # å®¢æˆ·ç«¯ä½¿ç”¨
```

#### `KAFKA_LISTENER_SECURITY_PROTOCOL_MAP`

- æ˜ å°„ listener åç§°åˆ°å®‰å…¨åè®®
- åè®®ç±»å‹:
  - `PLAINTEXT` - æ— åŠ å¯† (å¼€å‘/æµ‹è¯•)
  - `SSL` - TLS åŠ å¯†
  - `SASL_PLAINTEXT` - è®¤è¯ä½†æ— åŠ å¯†
  - `SASL_SSL` - è®¤è¯ + åŠ å¯† (ç”Ÿäº§ç¯å¢ƒ)

### é›†ç¾¤è§„æ¨¡ - å¿…é¡»å¥‡æ•°ä¸ªæ§åˆ¶å™¨!

| èŠ‚ç‚¹æ•° | éœ€è¦ä»²è£æ•° | å®¹å¿æ•…éšœæ•° | æ¨è?      |
| ------ | ---------- | ---------- | ---------- |
| 1      | 1          | 0          | ä»…å¼€å‘     |
| 2      | 2          | 0 âŒ       | ä¸è¦ç”¨!    |
| 3      | 2          | 1 âœ…       | æ ‡å‡†ç”Ÿäº§   |
| 4      | 3          | 1 (æµªè´¹!)  | ä¸è¦ç”¨!    |
| 5      | 3          | 2 âœ…       | å¤§è§„æ¨¡ç”Ÿäº§ |

**ä¸ºä»€ä¹ˆè¦å¥‡æ•°?** å¶æ•°èŠ‚ç‚¹çš„å®¹é”™èƒ½åŠ›å’Œ N-1 ç›¸åŒä½†æˆæœ¬æ›´é«˜ã€‚

### å¤åˆ¶é…ç½®

#### `KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR`

- æ¶ˆè´¹è€…åç§»é‡æ•°æ® (`__consumer_offsets` topic) çš„å¤åˆ¶å› å­
- å¼€å‘ç¯å¢ƒ: 1
- ç”Ÿäº§ç¯å¢ƒ: 3 âœ…

#### Min ISR

- æœ€å°åŒæ­¥å‰¯æœ¬æ•° (Minimum In-Sync Replicas)
- ç”Ÿäº§ç¯å¢ƒæ¨è: RF=3, Min ISR=2

## å››ã€Topics å’Œ Partitions (æœ€æ ¸å¿ƒæ¦‚å¿µ)

### Topic æ˜¯ä»€ä¹ˆ?

- **æ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»** (logical category)
- ç±»ä¼¼æ•°æ®åº“ä¸­çš„è¡¨æˆ–æ–‡ä»¶å¤¹
- ä¾‹å­: "user-clicks", "orders", "payment-events"

### Partitions - Kafka æœ€é‡è¦çš„æ¦‚å¿µ!

**Partition** = æœ‰åºçš„ã€ä¸å¯å˜çš„æ¶ˆæ¯åºåˆ— (ordered, immutable sequence)

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†åŒº?**

1. **å¹¶è¡Œæ€§ (Parallelism)** - å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥åŒæ—¶è¯»å–ä¸åŒåˆ†åŒº
2. **å¯æ‰©å±•æ€§ (Scalability)** - è·¨å¤šä¸ª broker åˆ†å¸ƒæ•°æ®
3. **æ’åºä¿è¯ (Ordering)** - åˆ†åŒºå†…æœ‰åºï¼Œè·¨åˆ†åŒºæ— åº
4. **å®¹é”™ (Fault tolerance)** - åˆ†åŒºè·¨ broker å¤åˆ¶

### æ¶ˆæ¯å¦‚ä½•åˆ†é…åˆ°åˆ†åŒº?

**1. æœ‰ Key (æœ€å¸¸è§):**

```
hash(key) % num_partitions = partition_id

ç¤ºä¾‹:
- user_id=123 â†’ æ€»æ˜¯åˆ†åŒº 1
- user_id=456 â†’ æ€»æ˜¯åˆ†åŒº 2
- åŒä¸€ç”¨æˆ·çš„äº‹ä»¶ä¿æŒé¡ºåº!
```

**2. æ—  Key (Round-robin):**

```
æ¶ˆæ¯å‡åŒ€åˆ†å¸ƒåˆ°æ‰€æœ‰åˆ†åŒº
- msg1 â†’ åˆ†åŒº 0
- msg2 â†’ åˆ†åŒº 1
- msg3 â†’ åˆ†åŒº 2
- msg4 â†’ åˆ†åŒº 0
```

**3. è‡ªå®šä¹‰ Partitioner:**

- è‡ªå·±ç¼–å†™é€»è¾‘å†³å®šåˆ†åŒº

### åˆ†åŒºæ•°é‡é€‰æ‹©

**è€ƒè™‘å› ç´ :**

**å¤ªå°‘:**

- å¹¶è¡Œåº¦æœ‰é™
- ååé‡ä½
- éš¾ä»¥æ‰©å±•

**å¤ªå¤š:**

- æ›´å¤šå¼€é”€ (æ–‡ä»¶å¥æŸ„ã€å†…å­˜)
- æ•…éšœæ—¶ leader é€‰ä¸¾æ›´æ…¢
- ç«¯åˆ°ç«¯å»¶è¿Ÿæ›´é«˜

**æŒ‡å¯¼åŸåˆ™:**

- **èµ·æ­¥**: 3-10 ä¸ªåˆ†åŒº
- **åŸºäºååé‡**: æ¯ä¸ªåˆ†åŒº ~10 MB/s
- **åŸºäºæ¶ˆè´¹è€…å¹¶è¡Œåº¦**: æœ€å¤§å¹¶å‘æ¶ˆè´¹è€…æ•° = åˆ†åŒºæ•°
- **ç”Ÿäº§ç¯å¢ƒ**: 10-30 ä¸ªåˆ†åŒºå¸¸è§
- **é‡è¦**: æ— æ³•å‡å°‘åˆ†åŒº (åªèƒ½å¢åŠ ) âŒ

### Replication - å¤åˆ¶æœºåˆ¶

**æ¯ä¸ªåˆ†åŒºæœ‰å‰¯æœ¬ (replicas) è·¨å¤šä¸ª broker:**

- **Leader replica** - å¤„ç†æ‰€æœ‰è¯»å†™
- **Follower replicas** - ä» leader æ‹‰å–æ•°æ®ç”¨äºæ•…éšœè½¬ç§»
- **Replication Factor 3** = 1 ä¸ª leader + 2 ä¸ª follower

**Follower å¦‚ä½•å¤åˆ¶?**

```
Leader (Broker1)
  â†“ (follower é€šè¿‡ Fetch API æ‹‰å–)
Follower (Broker2) - æ‹‰å–æ–°æ¶ˆæ¯ï¼Œå†™å…¥ç£ç›˜
  â†“ (follower é€šè¿‡ Fetch API æ‹‰å–)
Follower (Broker3) - æ‹‰å–æ–°æ¶ˆæ¯ï¼Œå†™å…¥ç£ç›˜
```

**ISR (In-Sync Replicas)** - ä¸ leader ä¿æŒåŒæ­¥çš„å‰¯æœ¬é›†åˆ

- Kafka åŠ¨æ€è·Ÿè¸ª ISR
- è½åçš„å‰¯æœ¬ä¼šè¢«ç§»å‡º ISR
- è¿½ä¸Šåä¼šè¢«åŠ å› ISR

### Min ISR (æœ€å°åŒæ­¥å‰¯æœ¬æ•°)

**é…ç½®: `min.insync.replicas=2`**

**å«ä¹‰:** è‡³å°‘ 2 ä¸ªå‰¯æœ¬å¿…é¡»ç¡®è®¤ï¼Œå†™å…¥æ‰æˆåŠŸ

**ç¤ºä¾‹ (RF=3, Min ISR=2):**

```
æ­£å¸¸: 3 ä¸ªå‰¯æœ¬åŒæ­¥
- å†™å…¥ â†’ Leader + 1 follower ç¡®è®¤ â†’ æˆåŠŸ âœ…

1 ä¸ª broker å®•æœº: 2 ä¸ªå‰¯æœ¬åŒæ­¥
- å†™å…¥ â†’ Leader + 1 follower ç¡®è®¤ â†’ æˆåŠŸ âœ…

2 ä¸ª broker å®•æœº: åªå‰© 1 ä¸ªå‰¯æœ¬ (leader)
- å†™å…¥ â†’ åªæœ‰ leader ç¡®è®¤ â†’ å¤±è´¥ âŒ
- å†™å…¥è¢«é˜»å¡ç›´åˆ°å¦ä¸€ä¸ªå‰¯æœ¬æ¢å¤
```

**ä¸ºä»€ä¹ˆé˜»å¡å†™å…¥?**

- **å®‰å…¨ä¼˜å…ˆäºå¯ç”¨æ€§**
- é˜²æ­¢ leader å´©æºƒåæ•°æ®ä¸¢å¤±
- å¼ºåˆ¶åœ¨æ¥å—æ›´å¤šæ•°æ®å‰ä¿®å¤é›†ç¾¤

**ç”Ÿäº§ç¯å¢ƒæ ‡å‡†:** RF=3, Min ISR=2 âœ…

### Offsets (åç§»é‡)

- æ¯æ¡æ¶ˆæ¯åœ¨åˆ†åŒºä¸­çš„é¡ºåº ID (0, 1, 2, 3, ...)
- **Offset** = æ¶ˆæ¯åœ¨åˆ†åŒºä¸­çš„ä½ç½®
- æ¶ˆè´¹è€…é€šè¿‡ offset è·Ÿè¸ªè¿›åº¦
- å¯ä»¥é€šè¿‡æ”¹å˜ offset é‡æ”¾æ¶ˆæ¯
- Offset æ˜¯åˆ†åŒºç‰¹å®šçš„ï¼Œä¸æ˜¯ topic èŒƒå›´çš„

## äº”ã€Producers (ç”Ÿäº§è€…)

### Producer æ˜¯ä»€ä¹ˆ?

**Producer** = å‘ Kafka topics å‘å¸ƒæ¶ˆæ¯çš„åº”ç”¨ç¨‹åº

### æ¶ˆæ¯æµç¨‹

```
1. Producer åˆ›å»ºæ¶ˆæ¯ (key, value, headers)
2. Serializer è½¬æ¢ä¸ºå­—èŠ‚
3. Partitioner å†³å®šåˆ†åŒº
4. æ¶ˆæ¯æ·»åŠ åˆ°è¯¥åˆ†åŒºçš„æ‰¹æ¬¡
5. Sender çº¿ç¨‹å‘é€æ‰¹æ¬¡åˆ°åˆ†åŒº leader
6. Leader å†™å…¥å¹¶å¤åˆ¶ (æ ¹æ® acks é…ç½®)
7. Leader å‘é€ ACK å› producer
```

### å…³é”®é…ç½®

#### `acks` - æœ€é‡è¦çš„æŒä¹…æ€§é…ç½®!

| acks  | å«ä¹‰            | æŒä¹…æ€§      | å»¶è¿Ÿ | ä½¿ç”¨åœºæ™¯                    |
| ----- | --------------- | ----------- | ---- | --------------------------- |
| `0`   | ä¸ç­‰ç¡®è®¤        | æœ€ä½ âŒ     | æœ€å¿« | æŒ‡æ ‡ã€æ—¥å¿— (å¯æ¥å—æ•°æ®ä¸¢å¤±) |
| `1`   | åªç­‰ leader     | ä¸­ç­‰        | å¿«   | å¹³è¡¡ (æœ‰ä¸€å®šé£é™©)           |
| `all` | ç­‰æ‰€æœ‰ ISR å‰¯æœ¬ | **æœ€é«˜** âœ… | æœ€æ…¢ | å…³é”®æ•°æ® (æ”¯ä»˜ã€è®¢å•)       |

**ç¤ºä¾‹:**

```python
# acks=0 - ä¸ç­‰ç¡®è®¤ (å‘åä¸ç®¡)
producer = KafkaProducer(acks=0)

# acks=1 - åªç­‰ leader (é»˜è®¤)
producer = KafkaProducer(acks=1)

# acks=all - ç­‰æ‰€æœ‰ ISR å‰¯æœ¬
producer = KafkaProducer(acks='all')
```

**acks=all + min.insync.replicas=2:**

- Producer ç­‰å¾… leader + è‡³å°‘ 1 ä¸ª follower
- å¼ºæŒä¹…æ€§ä¿è¯
- æ›´é«˜å»¶è¿Ÿ

#### `retries` å’Œ `max.in.flight.requests.per.connection`

**é—®é¢˜: æ¶ˆæ¯é‡æ’åº**

```
åœºæ™¯:
æ—¶é—´1: Producer å‘é€ msg1 â†’ Kafka (è¯·æ±‚åœ¨é€”ä¸­)
æ—¶é—´2: Producer å‘é€ msg2 â†’ Kafka (ä¸ç­‰ msg1 ACKï¼Œå› ä¸º max.in.flight=5)
æ—¶é—´3: msg1 å¤±è´¥ (ç½‘ç»œé—®é¢˜) âŒ
æ—¶é—´4: msg2 æˆåŠŸ âœ… (å†™å…¥åˆ†åŒº)
æ—¶é—´5: msg1 é‡è¯•
æ—¶é—´6: msg1 æˆåŠŸ âœ… (å†™å…¥åˆ†åŒº)

ç»“æœ: [msg2][msg1]  â† é‡æ’åºäº†! âŒ
```

**è§£å†³æ–¹æ¡ˆ 1: ä¸¥æ ¼æ’åº (ä½åå)**

```python
producer = KafkaProducer(
    retries=3,
    max.in.flight.requests.per.connection=1  # åªå…è®¸ 1 ä¸ªæœªç¡®è®¤è¯·æ±‚
)
```

- ç¼ºç‚¹: ååé‡ä½ (ç­‰å¾…æ¯ä¸ª ACK)

**è§£å†³æ–¹æ¡ˆ 2: å¹‚ç­‰ç”Ÿäº§è€… (æœ€ä½³!) âœ…**

```python
producer = KafkaProducer(
    enable_idempotence=True,  # å¤„ç†æ’åº + å»é‡
    retries=3,
    max.in.flight.requests.per.connection=5  # ä»å¯ç”¨ 5!
)
```

- Kafka ä¸ºæ¶ˆæ¯åˆ†é…åºåˆ—å·
- å³ä½¿ msg2 å…ˆåˆ°ï¼ŒKafka ä¹Ÿä¼šæ ¹æ®åºåˆ—å·é‡æ’åº
- **é«˜åå + æ’åºä¿è¯**
- **ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆæ¨è!** âœ…

#### `compression.type` - å‹ç¼©

```python
producer = KafkaProducer(
    compression_type='snappy'  # æˆ– 'gzip', 'lz4', 'zstd', 'none'
)
```

**å‹ç¼©ç±»å‹:**

- `snappy` - é€Ÿåº¦ä¸å‹ç¼©æ¯”å¹³è¡¡
- `lz4` - æ›´å¿«ï¼Œå‹ç¼©ç‡è¾ƒä½
- `gzip` - æ›´æ…¢ï¼Œå‹ç¼©ç‡æœ€é«˜
- `zstd` - æœ€ä½³å¹³è¡¡ (Kafka 2.1+) âœ…

**å¥½å¤„:**

- å‡å°‘ç½‘ç»œå¸¦å®½
- å‡å°‘ç£ç›˜ä½¿ç”¨
- æé«˜ååé‡

#### `batch.size` å’Œ `linger.ms` - æ‰¹å¤„ç†

```python
batch.size=16384      # 16KB æ‰¹æ¬¡åå‘é€
linger.ms=10          # ç­‰å¾… 10ms æ”¶é›†æ›´å¤šæ¶ˆæ¯
```

**æƒè¡¡:**

- æ›´å¤§ batch.size = æ›´é«˜ååï¼Œæ›´é«˜å»¶è¿Ÿ
- æ›´é«˜ linger.ms = æ›´å¤šæ‰¹å¤„ç†ï¼Œæ›´é«˜å»¶è¿Ÿ

### Producer æœ€ä½³å®è·µ

1. **å…³é”®æ•°æ®ç”¨ `acks=all` + `enable.idempotence=true`** âœ…
2. è®¾ç½®åˆé€‚è¶…æ—¶ - `request.timeout.ms`, `delivery.timeout.ms`
3. å¤„ç†å¤±è´¥ - åº”ç”¨çº§é‡è¯•é€»è¾‘
4. æ‰¹å¤„ç†æé«˜åå - è°ƒä¼˜ `batch.size` å’Œ `linger.ms`
5. å‹ç¼©æ•°æ® - èŠ‚çœç½‘ç»œå’Œç£ç›˜
6. ç›‘æ§æŒ‡æ ‡ - record-send-rate, record-error-rate, request-latency-avg
7. ä¼˜é›…å…³é—­ - è°ƒç”¨ `close()` åˆ·æ–°å¾…å‘é€æ¶ˆæ¯

## å…­ã€Consumers (æ¶ˆè´¹è€…)

### Consumer æ˜¯ä»€ä¹ˆ?

**Consumer** = ä» Kafka topics è¯»å–æ¶ˆæ¯çš„åº”ç”¨ç¨‹åº

### Consumer Group (æ¶ˆè´¹è€…ç»„) - æ ¸å¿ƒæ¦‚å¿µ!

**Consumer Group** = ä¸€ç»„ååŒæ¶ˆè´¹ topic çš„æ¶ˆè´¹è€…

**å…³é”®ç‰¹æ€§:**

- æ¯ä¸ªåˆ†åŒºåˆ†é…ç»™ç»„å†…**ä¸€ä¸ª**æ¶ˆè´¹è€…
- å¦‚æœæ¶ˆè´¹è€…å®•æœºï¼Œåˆ†åŒºé‡æ–°å¹³è¡¡ç»™å…¶ä»–æ¶ˆè´¹è€…
- å¤šä¸ªç»„å¯ä»¥ç‹¬ç«‹æ¶ˆè´¹åŒä¸€ topic

**ç¤ºä¾‹:**

```
Topic: orders (3 ä¸ªåˆ†åŒº)

ç»„ "order-processing":
  - Consumer A â†’ Partition 0
  - Consumer B â†’ Partition 1
  - Consumer C â†’ Partition 2

ç»„ "analytics" (ä¸åŒç»„):
  - Consumer X â†’ Partition 0, 1, 2 (æ‰€æœ‰åˆ†åŒº)

ä¸¤ä¸ªç»„ç‹¬ç«‹æ¶ˆè´¹! ğŸš€
```

### Rebalancing (é‡å¹³è¡¡)

**Rebalance** = åœ¨ç»„å†…æ¶ˆè´¹è€…ä¹‹é—´é‡æ–°åˆ†é…åˆ†åŒº

**è§¦å‘æ—¶æœº:**

1. æ¶ˆè´¹è€…åŠ å…¥ç»„
2. æ¶ˆè´¹è€…ç¦»å¼€ (å´©æºƒæˆ–å…³é—­)
3. æ¶ˆè´¹è€…è¢«è®¤ä¸ºæ­»äº¡ (å¿ƒè·³è¶…æ—¶)
4. åˆ†åŒºæ·»åŠ åˆ° topic

**è¿‡ç¨‹:**

```
åˆå§‹çŠ¶æ€:
- Consumer1: [P0, P1]
- Consumer2: [P2]

Consumer3 åŠ å…¥ â†’ è§¦å‘é‡å¹³è¡¡

é‡å¹³è¡¡å:
- Consumer1: [P0]
- Consumer2: [P1]
- Consumer3: [P2]
```

**é‡å¹³è¡¡æœŸé—´:**

- æ¶ˆè´¹è€…åœæ­¢æ¶ˆè´¹
- åˆ†åŒºé‡æ–°åˆ†é…
- æ¶ˆè´¹è€…æ¢å¤ (å»¶è¿Ÿå³°å€¼!)

### Offsets å’Œ Offset ç®¡ç†

**Offset** = æ¶ˆè´¹è€…åœ¨åˆ†åŒºä¸­çš„ä½ç½®

```
Partition 0:
[msg0][msg1][msg2][msg3][msg4][msg5]...
  â†‘
Consumer offset = 3 (ä¸‹ä¸€æ¡è¦è¯»çš„æ¶ˆæ¯)
```

#### Offset å­˜å‚¨

**Kafka åœ¨å†…éƒ¨ topic å­˜å‚¨ offset:**

```
Topic: __consumer_offsets (é»˜è®¤ 50 ä¸ªåˆ†åŒº)

å­˜å‚¨: (group_id, topic, partition) â†’ offset
```

**å…³é”®ç»“æ„:**

```
Key: (group_id, topic, partition)
Value: offset

ç¤ºä¾‹:
  ("fraud_detection", "user-activities", partition=0) â†’ offset=5
  ("activity_analytics", "user-activities", partition=0) â†’ offset=3
```

**ä¸ºä»€ä¹ˆä¸éœ€è¦ consumer ID?**

- ä¸€ä¸ªåˆ†åŒºåŒæ—¶åªåˆ†é…ç»™ç»„å†…ä¸€ä¸ªæ¶ˆè´¹è€…
- ç»„è·Ÿè¸ªä½ç½®ï¼Œä¸æ˜¯å•ä¸ªæ¶ˆè´¹è€…
- é‡å¹³è¡¡ä¸å½±å“ offset - æ–°æ¶ˆè´¹è€…ä»ç»„çš„æœ€å offset ç»§ç»­

**é‡å¹³è¡¡ç¤ºä¾‹:**

```
åˆå§‹:
  Consumer A â†’ P0 (ç»„ offset: 5)
  Consumer B â†’ P1 (ç»„ offset: 8)

Consumer A å´©æºƒ! é‡å¹³è¡¡:
  Consumer B â†’ P0, P1

Consumer B è¯»å– P0:
  Kafka: "ç»„æœ€åè¯»åˆ° P0 çš„ offset 5"
  Consumer B ä» offset 5 ç»§ç»­ âœ…

ä¸ç®¡ä¹‹å‰æ˜¯å“ªä¸ªæ¶ˆè´¹è€…!
```

**å…³é”®æ´å¯Ÿ:** ç»„æ˜¯æ¶ˆè´¹çš„å•ä½ï¼Œä¸æ˜¯å•ä¸ªæ¶ˆè´¹è€…ã€‚è¿™ä½¿å¾—:

- æ¶ˆè´¹è€…å®ä¾‹å¯ä»¥çµæ´»æ¥å»
- æ— ç¼é‡å¹³è¡¡
- æ›´ç®€å•çš„ offset ç®¡ç†

#### Offset æäº¤ç­–ç•¥

**1. è‡ªåŠ¨æäº¤ (é»˜è®¤)**

```python
consumer = KafkaConsumer(
    'topic',
    enable_auto_commit=True,      # è‡ªåŠ¨æäº¤
    auto_commit_interval_ms=5000  # æ¯ 5 ç§’æäº¤
)

for message in consumer:
    process(message)  # åå°è‡ªåŠ¨æäº¤
```

- é£é™©: å´©æºƒæ—¶å¯èƒ½ä¸¢æ¶ˆæ¯ (å·²å¤„ç†ä½†æœªæäº¤)

**2. æ‰‹åŠ¨åŒæ­¥æäº¤**

```python
consumer = KafkaConsumer(
    'topic',
    enable_auto_commit=False
)

for message in consumer:
    process(message)
    consumer.commit()  # å¤„ç†åæäº¤
```

- å¥½å¤„: å¤„ç† â†’ æäº¤ â†’ ä¿è¯ at-least-once

**3. æ‰‹åŠ¨å¼‚æ­¥æäº¤**

```python
consumer = KafkaConsumer(
    'topic',
    enable_auto_commit=False
)

for message in consumer:
    process(message)
    consumer.commit_async()  # éé˜»å¡æäº¤
```

- å¥½å¤„: æ›´å¥½æ€§èƒ½ï¼Œä¸ç­‰å¾…æäº¤

### å…³é”® Consumer é…ç½®

#### `group.id`

```python
consumer = KafkaConsumer(
    'topic',
    group_id='my-consumer-group'  # åŠ å…¥è¿™ä¸ªç»„
)
```

- å…³é”®: ç›¸åŒ `group.id` çš„æ¶ˆè´¹è€…å…±äº«åˆ†åŒºåˆ†é…

#### `auto.offset.reset`

**æ²¡æœ‰ offset æ—¶æ€ä¹ˆåŠ (æ–°æ¶ˆè´¹è€…ç»„):**

```python
auto_offset_reset='earliest'  # ä»å¤´å¼€å§‹
auto_offset_reset='latest'    # ä»æœ«å°¾å¼€å§‹ (é»˜è®¤)
auto_offset_reset='none'      # æŠ›å‡ºå¼‚å¸¸
```

#### `max.poll.records`

```python
max_poll_records=500  # æ¯æ¬¡ poll() æœ€å¤šæ‹‰å– 500 æ¡æ¶ˆæ¯
```

#### `session.timeout.ms` å’Œ `heartbeat.interval.ms`

```python
session_timeout_ms=10000     # 10s - æ— å¿ƒè·³åˆ™è§†ä¸ºæ­»äº¡
heartbeat_interval_ms=3000   # 3s - æ¯ 3s å‘é€å¿ƒè·³
```

**å…³ç³»:**

- `heartbeat.interval.ms` < `session.timeout.ms`
- é€šå¸¸: heartbeat = session timeout çš„ 1/3

### Consumer æœ€ä½³å®è·µ

1. **ä½¿ç”¨æ¶ˆè´¹è€…ç»„** å®ç°å¹¶è¡Œ (ä¸ç”¨å•ä¸ªæ¶ˆè´¹è€…)
2. **åŒ¹é…æ¶ˆè´¹è€…æ•°é‡åˆ°åˆ†åŒºæ•°é‡** (æˆ–æ›´å°‘)
   - 3 ä¸ªåˆ†åŒº â†’ æœ€å¤š 3 ä¸ªæ¶ˆè´¹è€… (ç¬¬ 4 ä¸ªä¼šé—²ç½®)
3. **å…³é”®æ•°æ®ç”¨æ‰‹åŠ¨æäº¤** (at-least-once å¤„ç†)
4. **å¹‚ç­‰å¤„ç†** - å¤„ç†é‡å¤æ¶ˆæ¯
5. **ç›‘æ§ lag** - æ¶ˆè´¹è€…è½åå¤šå°‘
6. **ä¼˜é›…å¤„ç†é‡å¹³è¡¡** - æš‚åœ/æ¢å¤å¤„ç†
7. è®¾ç½®åˆé€‚è¶…æ—¶ - session.timeout, request.timeout
8. å°½å¯èƒ½æ‰¹é‡å¤„ç†æé«˜æ•ˆç‡

## ä¸ƒã€ä¼ é€’è¯­ä¹‰ (Delivery Semantics)

### At-Most-Once (æœ€å¤šä¸€æ¬¡)

**é…ç½®:**

```python
producer: acks=0, retries=0
consumer: enable_auto_commit=True
```

- **è¡Œä¸º:** æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼Œä¸ä¼šé‡å¤
- **ä½¿ç”¨åœºæ™¯:** æŒ‡æ ‡ã€æ—¥å¿— (å¯æ¥å—ä¸¢å¤±)

### At-Least-Once (è‡³å°‘ä¸€æ¬¡) - æœ€å¸¸ç”¨ âœ…

**é…ç½®:**

```python
producer: acks=all, retries>0, enable.idempotence=False
consumer: enable_auto_commit=False, å¤„ç†åæ‰‹åŠ¨æäº¤
```

- **è¡Œä¸º:** æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œå¯èƒ½é‡å¤
- **ä½¿ç”¨åœºæ™¯:** å¤§å¤šæ•°ç”Ÿäº§å·¥ä½œè´Ÿè½½ + å¹‚ç­‰å¤„ç†

### Exactly-Once (æ°å¥½ä¸€æ¬¡)

**é…ç½®:**

```python
producer: enable_idempotence=True, transactional.id='unique-id'
consumer: isolation.level='read_committed'
```

- **è¡Œä¸º:** æ¶ˆæ¯æ°å¥½ä¼ é€’ä¸€æ¬¡ (ç«¯åˆ°ç«¯)
- **ä½¿ç”¨åœºæ™¯:** é‡‘èäº¤æ˜“ã€å…³é”®çŠ¶æ€å˜åŒ–
- **æ³¨æ„:** å¤æ‚ï¼Œéœ€è¦äº‹åŠ¡ API

## å…«ã€å¸¸è§æ¨¡å¼ (Common Patterns)

### Fan-Out æ¨¡å¼ (æ‰‡å‡º)

**ä¸€ä¸ª topicï¼Œå¤šä¸ªæ¶ˆè´¹è€…ç»„:**

```
Topic: events

ç»„ "email-service" â†’ å‘é€é‚®ä»¶
ç»„ "analytics" â†’ è·Ÿè¸ªæŒ‡æ ‡
ç»„ "audit-log" â†’ åˆè§„å­˜å‚¨

æ‰€æœ‰ç»„ç‹¬ç«‹æ¶ˆè´¹ç›¸åŒäº‹ä»¶
```

### Stream Processing (æµå¤„ç†)

**æ¶ˆè´¹è€…è¯»å–ã€è½¬æ¢ã€ç”Ÿäº§:**

```
Consumer (ç»„ "processor")
  â† ä» topic "raw-events" è¯»å–
  â†’ å¤„ç†/å¢å¼º
  â†’ ç”Ÿäº§åˆ° topic "enriched-events"
```

### Dead Letter Queue (æ­»ä¿¡é˜Ÿåˆ—)

**å¤±è´¥æ¶ˆæ¯å‘é€åˆ°å•ç‹¬ topic:**

```python
for message in consumer:
    try:
        process(message)
        consumer.commit()
    except ProcessingError:
        producer.send('dlq-topic', message)  # å‘é€åˆ° DLQ
        consumer.commit()  # æäº¤ä»¥é¿å…é‡è¯•
```

## ä¹ã€å°šæœªæ¶µç›–çš„é«˜çº§ä¸»é¢˜

**æŒ‰ä¼˜å…ˆçº§æ¨èå­¦ä¹ é¡ºåº:**

1. **Log Compaction (æ—¥å¿—å‹ç¼©)** - åªä¿ç•™æ¯ä¸ª key çš„æœ€æ–°å€¼
2. **Kafka Connect** - è¿æ¥å¤–éƒ¨ç³»ç»Ÿçš„æ¡†æ¶ (æ•°æ®åº“ã€S3 ç­‰)
3. **ç›‘æ§å’Œè¿ç»´** - ç”Ÿäº§ç¯å¢ƒå¿…å¤‡
   - æŒ‡æ ‡: UnderReplicatedPartitions, Consumer Lag
   - å·¥å…·: Prometheus + Grafana
4. **Schema Registry + Avro** - ç”Ÿäº§çº§æ•°æ®åºåˆ—åŒ–
5. **Kafka Streams** - æµå¤„ç†åº“
6. **å®‰å…¨** - è®¤è¯ (SASL)ã€åŠ å¯† (SSL/TLS)ã€æˆæƒ (ACLs)
7. **å¤šæ•°æ®ä¸­å¿ƒå¤åˆ¶** - MirrorMaker 2.0, ç¾éš¾æ¢å¤

## åã€å…³é”®è¦ç‚¹å›é¡¾ ğŸ¯

### å¿…é¡»è®°ä½çš„æ¦‚å¿µ:

1. **Partitions** = å¹¶è¡Œå¤„ç†çš„å…³é”®

   - åˆ†åŒºå†…æœ‰åºï¼Œè·¨åˆ†åŒºæ— åº
   - æ¶ˆè´¹è€…æ•°é‡ â‰¤ åˆ†åŒºæ•°é‡

2. **ISR + Min ISR** = æ•°æ®å®‰å…¨çš„æ ¸å¿ƒ

   - ISR = ä¸ leader åŒæ­¥çš„å‰¯æœ¬
   - Min ISR = å†™å…¥æˆåŠŸéœ€è¦çš„æœ€å°‘å‰¯æœ¬æ•°
   - ç”Ÿäº§æ ‡å‡†: RF=3, Min ISR=2

3. **Producer æœ€ä½³é…ç½®:**

   - `acks=all` - ç­‰æ‰€æœ‰ ISR ç¡®è®¤
   - `enable.idempotence=True` - é˜²é‡å¤ + ä¿åº

4. **Consumer Group** = ä¸€ç»„ååŒå·¥ä½œçš„æ¶ˆè´¹è€…

   - æ¯ä¸ªåˆ†åŒºåªåˆ†é…ç»™ç»„å†…ä¸€ä¸ªæ¶ˆè´¹è€…
   - ä¸åŒç»„å¯ç‹¬ç«‹æ¶ˆè´¹åŒä¸€ topic

5. **Offset** = æ¶ˆè´¹è¿›åº¦è·Ÿè¸ª

   - å­˜å‚¨åœ¨ `__consumer_offsets`
   - æŒ‰ (group_id, topic, partition) å­˜å‚¨
   - **ä¸éœ€è¦ consumer_id!**

6. **ç½‘ç»œé…ç½®å…³é”®:**

   - `LISTENERS` = Kafka ç»‘å®šåœ°å€
   - `ADVERTISED_LISTENERS` = å‘Šè¯‰å®¢æˆ·ç«¯çš„åœ°å€
   - å¿…é¡»å¯ä»å®¢æˆ·ç«¯è®¿é—®

7. **é›†ç¾¤è§„æ¨¡:**
   - **å¿…é¡»å¥‡æ•°ä¸ªæ§åˆ¶å™¨** (3, 5, 7)
   - å¶æ•°èŠ‚ç‚¹æµªè´¹èµ„æº

### å½“å‰å­¦ä¹ æ°´å¹³

**ä¸­é«˜çº§ (65-70%)** - å·²æŒæ¡æ ¸å¿ƒæ¦‚å¿µå’Œç”Ÿäº§æœ€ä½³å®è·µ âœ…

### ä¸‹ä¸€æ­¥

å­¦ä¹ é«˜çº§ä¸»é¢˜å¯ä»¥è¾¾åˆ°ä¸“å®¶çº§ (90%+) ğŸš€

---

**å¤ä¹ å®Œæˆæ—¶é—´:** 2025 å¹´ 11 æœˆ 23 æ—¥  
**å»ºè®®ä¸‹æ¬¡å¤ä¹ :** 1-2 å‘¨å
